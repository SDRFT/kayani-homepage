<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hayati | Your Health Team</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1419;
            --bg-light: #1a2634;
            --card: #1e2d3a;
            --card-light: #2a3f4f;
            --border: #3a4f5f;
            
            /* Agent Colors */
            --nura: #ff4b8c;
            --nura-dark: #e6407d;
            --layla: #a855f7;
            --layla-dark: #9333ea;
            --salma: #f97316;
            --salma-dark: #ea580c;
            --maya: #06b6d4;
            --maya-dark: #0891b2;
            --amira: #ec4899;
            --amira-dark: #db2777;
            --hana: #eab308;
            --hana-dark: #ca8a04;
            
            --green: #22c55e;
            --green-dark: #16a34a;
            --yellow: #ffc800;
            --red: #ef4444;
            --text: #ffffff;
            --text-light: #9ca3af;
            --text-muted: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
        }

        /* Header with current agent */
        header {
            padding: 16px 20px;
            background: var(--bg-light);
            border-bottom: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .agent-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .agent-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            transition: all 0.3s ease;
        }

        .agent-avatar.nura { background: linear-gradient(135deg, var(--nura) 0%, var(--nura-dark) 100%); }
        .agent-avatar.layla { background: linear-gradient(135deg, var(--layla) 0%, var(--layla-dark) 100%); }
        .agent-avatar.salma { background: linear-gradient(135deg, var(--salma) 0%, var(--salma-dark) 100%); }
        .agent-avatar.maya { background: linear-gradient(135deg, var(--maya) 0%, var(--maya-dark) 100%); }
        .agent-avatar.amira { background: linear-gradient(135deg, var(--amira) 0%, var(--amira-dark) 100%); }
        .agent-avatar.hana { background: linear-gradient(135deg, var(--hana) 0%, var(--hana-dark) 100%); }

        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--green);
            border-radius: 50%;
            border: 3px solid var(--bg-light);
        }

        .agent-details h1 {
            font-size: 18px;
            font-weight: 800;
        }

        .agent-details span {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 8px;
        }

        .stat {
            padding: 8px 12px;
            background: var(--card);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat.xp { color: var(--yellow); }
        .stat.streak { color: var(--salma); }

        /* Team Bar */
        .team-bar {
            padding: 12px 20px;
            background: var(--bg-light);
            border-bottom: 2px solid var(--border);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .team-bar::-webkit-scrollbar { display: none; }

        .team-member {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--card);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            opacity: 0.6;
        }

        .team-member:hover {
            opacity: 0.8;
        }

        .team-member.active {
            opacity: 1;
            border-color: var(--nura);
        }

        .team-member.active.layla { border-color: var(--layla); }
        .team-member.active.salma { border-color: var(--salma); }
        .team-member.active.maya { border-color: var(--maya); }
        .team-member.active.amira { border-color: var(--amira); }
        .team-member.active.hana { border-color: var(--hana); }

        .team-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .team-avatar.nura { background: var(--nura); }
        .team-avatar.layla { background: var(--layla); }
        .team-avatar.salma { background: var(--salma); }
        .team-avatar.maya { background: var(--maya); }
        .team-avatar.amira { background: var(--amira); }
        .team-avatar.hana { background: var(--hana); }

        .team-name {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* User Profile Summary */
        .profile-summary {
            padding: 12px 20px;
            background: var(--card);
            margin: 12px 16px;
            border-radius: 16px;
            border: 2px solid var(--border);
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-title {
            font-size: 12px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-progress {
            font-size: 12px;
            font-weight: 800;
            color: var(--green);
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .profile-tag {
            padding: 4px 10px;
            background: var(--card-light);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-light);
        }

        .profile-tag.symptom { background: rgba(255, 75, 140, 0.2); color: var(--nura); }
        .profile-tag.age { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .profile-tag.goal { background: rgba(255, 200, 0, 0.2); color: var(--yellow); }

        /* Chat */
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Agent Message */
        .agent-msg {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .msg-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .msg-avatar.nura { background: var(--nura); }
        .msg-avatar.layla { background: var(--layla); }
        .msg-avatar.salma { background: var(--salma); }
        .msg-avatar.maya { background: var(--maya); }
        .msg-avatar.amira { background: var(--amira); }
        .msg-avatar.hana { background: var(--hana); }

        .msg-bubble {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 20px;
            border-top-left-radius: 6px;
            padding: 14px 18px;
            max-width: 320px;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.6;
        }

        .msg-bubble strong { color: var(--nura); }
        .msg-bubble.layla strong { color: var(--layla); }
        .msg-bubble.salma strong { color: var(--salma); }
        .msg-bubble.maya strong { color: var(--maya); }

        .msg-bubble em {
            color: var(--yellow);
            font-style: normal;
            font-weight: 800;
        }

        /* User Message */
        .user-msg {
            align-self: flex-end;
            background: var(--green);
            padding: 14px 18px;
            border-radius: 20px;
            border-bottom-right-radius: 6px;
            max-width: 280px;
            font-size: 15px;
            font-weight: 700;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Typing */
        .typing-container {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .typing-bubble {
            display: flex;
            gap: 6px;
            padding: 16px 24px;
            background: var(--card);
            border-radius: 20px;
            border-top-left-radius: 6px;
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background: var(--nura);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Handoff Card */
        .handoff-card {
            background: linear-gradient(135deg, var(--card) 0%, var(--card-light) 100%);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin: 8px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .handoff-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .handoff-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 16px;
            animation: popIn 0.5s ease 0.2s both;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .handoff-name {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 4px;
        }

        .handoff-specialty {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 16px;
        }

        .handoff-intro {
            font-size: 15px;
            color: var(--text);
            font-style: italic;
            line-height: 1.6;
        }

        /* Quick Options */
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-left: 56px;
            margin-top: 8px;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--card);
            border: 2px solid var(--border);
            border-bottom-width: 4px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            font-family: inherit;
            width: 100%;
        }

        .option-btn:hover {
            border-color: var(--nura);
            transform: translateY(-2px);
        }

        .option-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .option-btn .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .option-btn.green .dot { background: var(--green); }
        .option-btn.yellow .dot { background: var(--yellow); }
        .option-btn.orange .dot { background: var(--salma); }
        .option-btn.red .dot { background: var(--red); }

        /* Input */
        .input-area {
            padding: 16px 20px 32px;
            background: var(--bg-light);
            border-top: 3px solid var(--border);
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .text-input {
            flex: 1;
            padding: 14px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 24px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            color: var(--text);
            outline: none;
        }

        .text-input::placeholder { color: var(--text-muted); }
        .text-input:focus { border-color: var(--nura); }

        .send-btn {
            width: 52px;
            height: 52px;
            background: var(--nura);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover { transform: scale(1.05); }

        .send-btn svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--nura);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }

        /* API Key Modal */
        .api-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .api-modal.hidden { display: none; }

        .api-card {
            background: var(--bg-light);
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .api-card h2 {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .api-card p {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
        }

        .api-input {
            width: 100%;
            padding: 16px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: monospace;
            color: var(--text);
            margin-bottom: 16px;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--nura);
        }

        .api-btn {
            width: 100%;
            padding: 16px;
            background: var(--green);
            border: none;
            border-bottom: 4px solid var(--green-dark);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            color: white;
            cursor: pointer;
            font-family: inherit;
        }

        .api-btn:hover { filter: brightness(1.1); }

        .api-skip {
            margin-top: 16px;
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .api-skip:hover { color: var(--text); }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="api-modal" id="apiModal">
        <div class="api-card">
            <h2>üîë Connect AI</h2>
            <p>Enter your Anthropic API key to enable real AI conversations with Dr. Nura and the team.</p>
            <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-api...">
            <button class="api-btn" onclick="saveApiKey()">Connect</button>
            <div class="api-skip" onclick="skipApiKey()">Skip for now (demo mode)</div>
        </div>
    </div>

    <div class="app">
        <!-- Header -->
        <header>
            <div class="agent-info">
                <div class="agent-avatar nura" id="headerAvatar">
                    üë©‚Äç‚öïÔ∏è
                    <div class="online-dot"></div>
                </div>
                <div class="agent-details">
                    <h1 id="headerName">Dr. Nura</h1>
                    <span id="headerRole">Lead Health Companion</span>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat streak">üî• <span id="streak">1</span></div>
                <div class="stat xp">‚ö° <span id="xp">0</span></div>
            </div>
        </header>

        <!-- Team Bar -->
        <div class="team-bar">
            <div class="team-member active" data-agent="nura" onclick="switchAgent('nura')">
                <div class="team-avatar nura">üë©‚Äç‚öïÔ∏è</div>
                <span class="team-name">Nura</span>
            </div>
            <div class="team-member" data-agent="layla" onclick="switchAgent('layla')">
                <div class="team-avatar layla">üíá‚Äç‚ôÄÔ∏è</div>
                <span class="team-name">Layla</span>
            </div>
            <div class="team-member" data-agent="salma" onclick="switchAgent('salma')">
                <div class="team-avatar salma">üèãÔ∏è‚Äç‚ôÄÔ∏è</div>
                <span class="team-name">Salma</span>
            </div>
            <div class="team-member" data-agent="maya" onclick="switchAgent('maya')">
                <div class="team-avatar maya">üß†</div>
                <span class="team-name">Maya</span>
            </div>
            <div class="team-member" data-agent="amira" onclick="switchAgent('amira')">
                <div class="team-avatar amira">ü§∞</div>
                <span class="team-name">Amira</span>
            </div>
            <div class="team-member" data-agent="hana" onclick="switchAgent('hana')">
                <div class="team-avatar hana">üî•</div>
                <span class="team-name">Hana</span>
            </div>
        </div>

        <!-- Profile Summary (shows collected data) -->
        <div class="profile-summary" id="profileSummary">
            <div class="profile-header">
                <span class="profile-title">Your Profile</span>
                <span class="profile-progress" id="profileProgress">0% Complete</span>
            </div>
            <div class="profile-tags" id="profileTags">
                <span class="profile-tag">Start chatting to build your profile...</span>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat" id="chat"></div>

        <!-- Input -->
        <div class="input-area">
            <div class="input-row">
                <input type="text" class="text-input" id="textInput" placeholder="Message Dr. Nura...">
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Dr. Nura is thinking...</div>
        </div>
    </div>

    <script>
        // ========================================
        // AGENTS CONFIGURATION
        // ========================================
        const agents = {
            nura: {
                name: "Dr. Nura",
                role: "Lead Health Companion",
                emoji: "üë©‚Äç‚öïÔ∏è",
                color: "nura",
                personality: `You are Dr. Nura, a warm, witty, and knowledgeable women's health AI companion. You're like a fun big sister who also went to medical school.

Your personality:
- Playful but professional - use emojis sparingly but effectively
- Use casual language: "honey", "girl", "bestie" occasionally
- Be encouraging and validating - never dismissive
- Make health info accessible, not scary
- Use humor to lighten heavy topics
- Be direct and honest - no sugarcoating important info

Your role:
- You're the MAIN coordinator of the user's health journey
- Do initial intake and understand their concerns
- Track ALL symptoms, history, and data
- Route to specialists when needed (announce handoffs clearly)
- Synthesize insights from all specialists

When to hand off to specialists:
- Hair/skin issues ‚Üí Dr. Layla
- Weight/nutrition ‚Üí Dr. Salma  
- Mental health/anxiety/mood ‚Üí Dr. Maya
- Fertility/pregnancy ‚Üí Dr. Amira
- Menopause/perimenopause ‚Üí Dr. Hana

Keep responses concise (2-4 sentences usually). Ask ONE question at a time.`,
                greeting: "Hey girl! üëã I'm Dr. Nura, your personal health bestie (who also went to med school üòâ). I'm here to help you figure out what's going on with your body. So tell me ‚Äî what's bringing you to me today?"
            },
            layla: {
                name: "Dr. Layla",
                role: "Hair & Skin Specialist",
                emoji: "üíá‚Äç‚ôÄÔ∏è",
                color: "layla",
                personality: `You are Dr. Layla, a nurturing and insightful hair and skin specialist. You believe the body tells stories through hair and skin.

Your personality:
- Warm and caring, like a gentle older sister
- Use phrases like "your body is telling us something"
- Focus on root causes, not just symptoms
- Connect hair/skin issues to hormones when relevant
- Reassuring but thorough

Your expertise:
- Hair loss, thinning, texture changes
- Acne, especially hormonal acne
- Skin changes related to hormones
- Understanding the hair-hormone connection

Keep responses warm and supportive. Always connect symptoms to potential hormonal causes.`,
                greeting: "Hi sweetheart üíú I'm Dr. Layla. Nura told me you're dealing with some hair or skin stuff. These changes can feel so frustrating, but they're actually your body trying to tell you something. Let's figure out what it's saying together. What's been going on?"
            },
            salma: {
                name: "Dr. Salma",
                role: "Weight & Nutrition",
                emoji: "üèãÔ∏è‚Äç‚ôÄÔ∏è",
                color: "salma",
                personality: `You are Dr. Salma, a no-nonsense but supportive weight and nutrition specialist. You believe in tough love with compassion.

Your personality:
- Direct and honest - no BS
- Motivating, like a firm but caring coach
- Use phrases like "let's be real here", "no sugarcoating"
- Focus on sustainable changes, not quick fixes
- Hold them accountable but with empathy

Your expertise:
- Weight changes related to hormones
- Metabolic health
- Nutrition for hormonal balance
- Exercise and lifestyle factors
- GLP-1s and weight management options

Be encouraging but realistic. Challenge excuses gently.`,
                greeting: "Hey! üí™ I'm Dr. Salma. Nura mentioned you're dealing with some weight stuff. Let me be real with you ‚Äî I'm not here to judge, but I'm also not gonna sugarcoat things. Hormones can be a HUGE factor in weight, and sometimes it's not just about willpower. Let's dig in. What's been happening?"
            },
            maya: {
                name: "Dr. Maya",
                role: "Mental Wellness",
                emoji: "üß†",
                color: "maya",
                personality: `You are Dr. Maya, a gentle and validating mental health specialist. You create the safest possible space.

Your personality:
- Extremely gentle and non-judgmental
- Use phrases like "that makes sense", "your feelings are valid"
- Never rush or pressure
- Normalize struggles
- Careful with language around mental health

Your expertise:
- Anxiety and mood changes
- Hormonal impacts on mental health
- Stress management
- When to seek additional help
- Crisis support (always provide resources if needed)

IMPORTANT: If someone expresses suicidal thoughts or self-harm, take it seriously, validate their pain, and provide crisis resources. Never minimize.`,
                greeting: "Hi there üíô I'm Dr. Maya. Nura mentioned you might be going through some tough stuff emotionally. First, I want you to know ‚Äî whatever you're feeling is valid. This is a completely safe space, no judgment. Take your time. What's been on your mind?"
            },
            amira: {
                name: "Dr. Amira",
                role: "Fertility & Pregnancy",
                emoji: "ü§∞",
                color: "amira",
                personality: `You are Dr. Amira, a hopeful and expert fertility and pregnancy specialist. You balance optimism with realistic information.

Your personality:
- Hopeful but honest
- Expert and reassuring
- Sensitive to the emotional weight of fertility
- Celebrate wins, support through struggles
- Never dismissive of concerns

Your expertise:
- Trying to conceive
- Fertility tracking and optimization
- Pregnancy concerns
- Postpartum issues
- Reproductive options

Be sensitive ‚Äî fertility can be an emotional journey. Validate feelings while providing expert guidance.`,
                greeting: "Hi lovely üíï I'm Dr. Amira. Nura told me you have some questions about fertility or pregnancy. I know this journey can bring up so many emotions ‚Äî I'm here to support you through all of it. What's on your mind?"
            },
            hana: {
                name: "Dr. Hana",
                role: "Menopause & Midlife",
                emoji: "üî•",
                color: "hana",
                personality: `You are Dr. Hana, a wise and empowering menopause specialist. You reframe menopause as a powerful transition.

Your personality:
- Wise and empowering
- Use phrases like "this is YOUR time", "reclaiming your power"
- Normalize perimenopause and menopause symptoms
- Knowledgeable about HRT and alternatives
- Combat the stigma around menopause

Your expertise:
- Perimenopause symptoms
- Menopause management
- HRT education and options
- Hot flashes, sleep issues, mood changes
- Long-term health in menopause

Empower and educate. This isn't an ending ‚Äî it's a new chapter.`,
                greeting: "Hello beautiful! ‚ú® I'm Dr. Hana. Nura mentioned you might be navigating some changes that sound like perimenopause or menopause territory. First things first ‚Äî this is NOT the beginning of the end. This is a powerful transition, and I'm here to help you thrive through it. What's been going on?"
            }
        };

        // ========================================
        // STATE
        // ========================================
        let state = {
            apiKey: localStorage.getItem('hayati_api_key') || null,
            currentAgent: 'nura',
            xp: 0,
            streak: 1,
            conversationHistory: [],
            userProfile: {
                symptoms: [],
                age: null,
                cycleStatus: null,
                concerns: [],
                goals: []
            },
            agentConversations: {
                nura: [],
                layla: [],
                salma: [],
                maya: [],
                amira: [],
                hana: []
            }
        };

        // ========================================
        // API KEY HANDLING
        // ========================================
        function checkApiKey() {
            if (state.apiKey) {
                document.getElementById('apiModal').classList.add('hidden');
                startConversation();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                state.apiKey = key;
                localStorage.setItem('hayati_api_key', key);
                document.getElementById('apiModal').classList.add('hidden');
                startConversation();
            }
        }

        function skipApiKey() {
            state.apiKey = 'demo';
            document.getElementById('apiModal').classList.add('hidden');
            startConversation();
        }

        // ========================================
        // UI FUNCTIONS
        // ========================================
        const chat = document.getElementById('chat');

        function addAgentMessage(text, agent = state.currentAgent) {
            const a = agents[agent];
            const div = document.createElement('div');
            div.className = 'agent-msg';
            div.innerHTML = `
                <div class="msg-avatar ${a.color}">${a.emoji}</div>
                <div class="msg-bubble ${a.color}">${formatText(text)}</div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            
            // Save to conversation history
            state.agentConversations[agent].push({ role: 'assistant', content: text });
        }

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'user-msg';
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            
            // Save to conversation history
            state.agentConversations[state.currentAgent].push({ role: 'user', content: text });
        }

        function formatText(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function showTyping(agent = state.currentAgent) {
            const a = agents[agent];
            const div = document.createElement('div');
            div.className = 'typing-container';
            div.id = 'typing';
            div.innerHTML = `
                <div class="msg-avatar ${a.color}">${a.emoji}</div>
                <div class="typing-bubble">
                    <div class="typing-dot" style="background: var(--${a.color})"></div>
                    <div class="typing-dot" style="background: var(--${a.color})"></div>
                    <div class="typing-dot" style="background: var(--${a.color})"></div>
                </div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function hideTyping() {
            const t = document.getElementById('typing');
            if (t) t.remove();
        }

        function showHandoff(toAgent) {
            const a = agents[toAgent];
            const div = document.createElement('div');
            div.className = 'handoff-card';
            div.innerHTML = `
                <div class="handoff-title">‚ú® Connecting you with a specialist ‚ú®</div>
                <div class="handoff-avatar" style="background: linear-gradient(135deg, var(--${a.color}) 0%, var(--${a.color}-dark) 100%)">${a.emoji}</div>
                <div class="handoff-name">${a.name}</div>
                <div class="handoff-specialty">${a.role}</div>
                <div class="handoff-intro">"${a.greeting.split('.')[0]}..."</div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateHeader(agent) {
            const a = agents[agent];
            document.getElementById('headerAvatar').className = `agent-avatar ${a.color}`;
            document.getElementById('headerAvatar').innerHTML = `${a.emoji}<div class="online-dot"></div>`;
            document.getElementById('headerName').textContent = a.name;
            document.getElementById('headerRole').textContent = a.role;
            document.getElementById('textInput').placeholder = `Message ${a.name}...`;
            
            // Update team bar
            document.querySelectorAll('.team-member').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.agent === agent) el.classList.add('active');
            });
        }

        function updateProfile() {
            const tags = document.getElementById('profileTags');
            const progress = document.getElementById('profileProgress');
            
            let html = '';
            let completed = 0;
            const total = 5;
            
            if (state.userProfile.symptoms.length > 0) {
                state.userProfile.symptoms.forEach(s => {
                    html += `<span class="profile-tag symptom">${s}</span>`;
                });
                completed++;
            }
            
            if (state.userProfile.age) {
                html += `<span class="profile-tag age">${state.userProfile.age}</span>`;
                completed++;
            }
            
            if (state.userProfile.goals.length > 0) {
                state.userProfile.goals.forEach(g => {
                    html += `<span class="profile-tag goal">${g}</span>`;
                });
                completed++;
            }
            
            if (!html) {
                html = '<span class="profile-tag">Start chatting to build your profile...</span>';
            }
            
            tags.innerHTML = html;
            progress.textContent = `${Math.round((completed / total) * 100)}% Complete`;
        }

        function addXP(amount) {
            state.xp += amount;
            document.getElementById('xp').textContent = state.xp;
        }

        function showLoading(text = 'Thinking...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // ========================================
        // AI COMMUNICATION
        // ========================================
        async function callClaude(userMessage) {
            const agent = agents[state.currentAgent];
            
            // Build conversation history for this agent
            const messages = state.agentConversations[state.currentAgent].map(m => ({
                role: m.role,
                content: m.content
            }));
            
            // Add new user message
            messages.push({ role: 'user', content: userMessage });
            
            // Build system prompt with user profile context
            let systemPrompt = agent.personality;
            
            if (Object.values(state.userProfile).some(v => v && (Array.isArray(v) ? v.length > 0 : true))) {
                systemPrompt += `\n\nUser Profile (what we know so far):
- Symptoms: ${state.userProfile.symptoms.join(', ') || 'Not yet collected'}
- Age: ${state.userProfile.age || 'Not yet collected'}
- Cycle Status: ${state.userProfile.cycleStatus || 'Not yet collected'}
- Concerns: ${state.userProfile.concerns.join(', ') || 'Not yet collected'}
- Goals: ${state.userProfile.goals.join(', ') || 'Not yet collected'}

Use this context to personalize your responses.`;
            }
            
            // Demo mode - use scripted responses
            if (state.apiKey === 'demo') {
                return getDemoResponse(userMessage, state.currentAgent);
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        system: systemPrompt,
                        messages: messages
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('API Error:', error);
                return "Oops! I had a little hiccup there. Can you try again? üíï";
            }
        }

        function getDemoResponse(message, agent) {
            // Simple demo responses based on keywords
            const lower = message.toLowerCase();
            
            if (agent === 'nura') {
                if (lower.includes('hair') || lower.includes('skin') || lower.includes('acne')) {
                    return "Oh, hair or skin stuff? Those are actually my girl **Dr. Layla's** specialty! She's amazing at connecting the dots between what's happening on the outside and what's going on hormonally. Let me introduce you! üíú";
                }
                if (lower.includes('weight') || lower.includes('diet') || lower.includes('eating')) {
                    return "Weight stuff can be SO frustrating, especially when hormones are involved. I want you to meet **Dr. Salma** ‚Äî she's our nutrition and weight specialist. Fair warning: she keeps it real, but in the best way! üí™";
                }
                if (lower.includes('anxious') || lower.includes('anxiety') || lower.includes('depressed') || lower.includes('mood')) {
                    return "I hear you, and I'm glad you're talking about this. Mental health and hormones are SO connected. I want you to chat with **Dr. Maya** ‚Äî she specializes in the emotional side of things and she's the gentlest soul. üíô";
                }
                if (lower.includes('pregnant') || lower.includes('fertility') || lower.includes('trying') || lower.includes('baby')) {
                    return "Fertility and pregnancy questions? You're gonna love **Dr. Amira**! She's our expert on all things baby-making and pregnancy. She's incredibly supportive and knowledgeable. ü§∞";
                }
                if (lower.includes('menopause') || lower.includes('hot flash') || lower.includes('perimenopause')) {
                    return "Sounds like you might be entering the next chapter! **Dr. Hana** is our menopause queen ‚Äî she'll help you understand what's happening and how to thrive through it. This isn't an ending, it's a beginning! üî•";
                }
                if (lower.includes('tired') || lower.includes('exhausted') || lower.includes('fatigue')) {
                    return "Ugh, fatigue is the WORST. And it can be caused by so many things ‚Äî thyroid, iron, hormones, sleep issues. Tell me more: when did this start, and how's your sleep been? üò¥";
                }
                return "Thanks for sharing that with me! üíï Tell me a bit more ‚Äî when did you first start noticing this? And on a scale of 1-10, how much is it affecting your daily life?";
            }
            
            // Default for other agents
            return "I hear you. Tell me more about that ‚Äî when did it start, and what have you tried so far?";
        }

        // ========================================
        // AGENT SWITCHING & HANDOFFS
        // ========================================
        async function switchAgent(agentId) {
            if (agentId === state.currentAgent) return;
            
            const prevAgent = state.currentAgent;
            state.currentAgent = agentId;
            updateHeader(agentId);
            
            // Clear chat for new agent
            chat.innerHTML = '';
            
            // Show handoff if coming from another agent
            if (prevAgent !== agentId && state.agentConversations[prevAgent].length > 0) {
                showHandoff(agentId);
                await delay(1500);
            }
            
            // Show greeting or continue conversation
            if (state.agentConversations[agentId].length === 0) {
                showTyping(agentId);
                await delay(1000);
                hideTyping();
                addAgentMessage(agents[agentId].greeting, agentId);
            } else {
                // Restore previous conversation
                state.agentConversations[agentId].forEach(msg => {
                    if (msg.role === 'assistant') {
                        addAgentMessage(msg.content, agentId);
                    } else {
                        addUserMessage(msg.content);
                    }
                });
            }
            
            addXP(5);
        }

        function detectHandoff(response) {
            const lower = response.toLowerCase();
            if (lower.includes('dr. layla')) return 'layla';
            if (lower.includes('dr. salma')) return 'salma';
            if (lower.includes('dr. maya')) return 'maya';
            if (lower.includes('dr. amira')) return 'amira';
            if (lower.includes('dr. hana')) return 'hana';
            return null;
        }

        // ========================================
        // SEND MESSAGE
        // ========================================
        async function sendMessage() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            addUserMessage(text);
            
            // Extract profile data from message
            extractProfileData(text);
            
            showTyping();
            
            const response = await callClaude(text);
            
            hideTyping();
            addAgentMessage(response);
            addXP(10);
            
            // Check for handoff
            const handoff = detectHandoff(response);
            if (handoff) {
                await delay(2000);
                switchAgent(handoff);
            }
        }

        function extractProfileData(text) {
            const lower = text.toLowerCase();
            
            // Extract symptoms
            const symptoms = ['tired', 'fatigue', 'headache', 'anxiety', 'mood swing', 'weight', 'hair', 'acne', 'sleep', 'hot flash'];
            symptoms.forEach(s => {
                if (lower.includes(s) && !state.userProfile.symptoms.includes(s)) {
                    state.userProfile.symptoms.push(s);
                }
            });
            
            // Extract age mentions
            const ageMatch = text.match(/(\d{2})\s*(years|year|yo|y\/o)?/i);
            if (ageMatch) {
                state.userProfile.age = ageMatch[1] + ' years old';
            }
            
            updateProfile();
        }

        // ========================================
        // UTILITIES
        // ========================================
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Enter key to send
        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ========================================
        // START
        // ========================================
        function startConversation() {
            showTyping('nura');
            setTimeout(() => {
                hideTyping();
                addAgentMessage(agents.nura.greeting, 'nura');
            }, 1500);
        }

        // Check for API key on load
        checkApiKey();
    </script>
</body>
</html>
